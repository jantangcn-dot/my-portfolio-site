<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>作品集</title>
  <!-- 轻量样式，使用 Tailwind CDN 方便替换；生产环境可改为本地构建 -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .aspect-3-4 { aspect-ratio: 3 / 4; }
    .line-clamp-2 {
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
  </style>
</head>
<body class="bg-slate-50 text-slate-900">
  <header class="sticky top-0 z-10 border-b border-slate-200 bg-white/80 backdrop-blur">
    <div class="mx-auto max-w-6xl px-4 py-3 flex items-center justify-between">
      <h1 class="text-2xl font-extrabold">作品集</h1>
      <nav class="text-sm text-slate-500">无需代理 · 本地 CSV</nav>
    </div>
  </header>

  <main class="mx-auto max-w-6xl px-4 py-6 space-y-10">

    <!-- SFW -->
    <section>
      <div class="flex items-end gap-3 mb-3">
        <h2 class="text-2xl font-bold">公开作品（SFW）</h2>
        <span id="sfw-count" class="text-xs rounded-full border border-slate-300 px-2 py-0.5 text-slate-500">0 项</span>
      </div>
      <div id="gallery-sfw" class="grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-3"></div>
      <div id="sfw-empty" class="hidden rounded-lg border border-dashed border-slate-300 p-6 text-center text-slate-500">
        暂无 SFW 作品
      </div>
    </section>

    <!-- R18 -->
    <section>
      <div class="flex items-end gap-3 mb-3">
        <h2 class="text-2xl font-bold">私人作品（R-18）</h2>
        <span id="r18-count" class="text-xs rounded-full border border-slate-300 px-2 py-0.5 text-slate-500">0 项</span>
      </div>
      <div id="gallery-r18" class="grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-3"></div>
      <div id="r18-empty" class="hidden rounded-lg border border-dashed border-slate-300 p-6 text-center text-slate-500">
        暂无 R-18 作品
      </div>
    </section>

  </main>

  <!-- 预览弹窗 -->
  <dialog id="viewer" class="rounded-xl border border-slate-200 backdrop:bg-black/50 w-[92vw] max-w-5xl">
    <div class="flex justify-end border-b border-slate-200 p-2">
      <button class="rounded-md bg-slate-100 px-3 py-1.5 text-sm hover:bg-slate-200" onclick="viewer.close()">关闭</button>
    </div>
    <div class="grid gap-4 p-4 sm:grid-cols-2">
      <img id="viewer-img" class="w-full max-h-[80vh] object-contain bg-black" src="" alt="preview" referrerpolicy="no-referrer"
           onerror="this.onerror=null; this.src='https://placehold.co/1200x1600?text=Image+Error';">
      <div>
        <h3 id="viewer-title" class="mb-2 text-xl font-bold"></h3>
        <p id="viewer-desc" class="text-slate-600 leading-7"></p>
        <div id="viewer-tags" class="mt-3 flex flex-wrap gap-2"></div>
      </div>
    </div>
  </dialog>

<script>
// ============== 配置 ==============
const CSV_URL = '/data/works.csv?v=' + Date.now(); // 绝对路径 + 防缓存
// ============== 全局数据 ==========
let artworksData = [];
let sfwItems = [], r18Items = [];

// ============== 工具函数 ==========
function setLanguage(){ /* 预留占位，避免旧代码调用报错 */ }

// CSV 解析：支持逗号/引号/转义
function parseCSV(text) {
  const lines = text.replace(/\r\n?/g, '\n').split('\n').filter(l => l.trim().length);
  if (!lines.length) return [];
  const headers = splitCSVLine(lines[0]).map(s => s.trim());
  const rows = [];
  for (let i = 1; i < lines.length; i++) {
    const cols = splitCSVLine(lines[i]);
    const obj = {};
    headers.forEach((h, idx) => {
      let v = cols[idx] ?? '';
      // 去掉包裹引号与转义引号
      if (/^".*"$/.test(v)) v = v.slice(1, -1).replace(/""/g, '"');
      obj[h] = v.trim();
    });
    if (Object.values(obj).some(v => v !== '')) rows.push(obj);
  }
  return rows;
}
function splitCSVLine(line){
  const out=[]; let cur=''; let q=false;
  for(let i=0;i<line.length;i++){
    const ch=line[i];
    if(ch === '"'){
      if(q && line[i+1]==='"'){ cur+='"'; i++; }
      else q=!q;
    }else if(ch === ',' && !q){ out.push(cur); cur=''; }
    else { cur+=ch; }
  }
  out.push(cur);
  return out;
}
function tagChips(str){
  if(!str) return '';
  return str.split(',').map(s=>s.trim()).filter(Boolean).slice(0,6)
    .map(t=>`<span class="text-xs rounded-full bg-violet-50 text-violet-700 px-2 py-0.5">${t}</span>`).join('');
}
function safeImageSrc(url){
  if(!url) return '';
  url = String(url).trim().replace(/^http:\/\//i,'https://');
  return url; // 不使用任何图片代理
}

// ============== 渲染 =============
function renderGallery(container, items, isR18=false){
  if(!container) return;
  if(!items.length){
    container.classList.add('hidden');
    (isR18 ? document.getElementById('r18-empty') : document.getElementById('sfw-empty')).classList.remove('hidden');
    return;
  }
  container.innerHTML = items.map((item, idx)=>{
    const title = item.title_zh || item.title_en || '未命名';
    const desc = item.description_zh || item.description_en || '';
    return `
      <article class="overflow-hidden rounded-xl border border-slate-200 bg-white shadow-sm hover:shadow transition"
               onclick="openViewer(${idx}, ${isR18})">
        <div class="aspect-3-4 bg-slate-100 overflow-hidden">
          <img src="${safeImageSrc(item.imageUrl)}" alt="${title}" class="w-full h-full object-cover"
               referrerpolicy="no-referrer"
               onerror="this.onerror=null; this.src='https://placehold.co/800x1067?text=Image+Error';">
        </div>
        <div class="p-3">
          <h3 class="truncate text-base font-semibold">${title}</h3>
          <p class="mt-1 text-sm text-slate-600 line-clamp-2">${desc}</p>
          <div class="mt-2 flex flex-wrap gap-2">${tagChips(item.tags)}</div>
        </div>
      </article>`;
  }).join('');
}
function openViewer(idx, isR18){
  const item = isR18 ? r18Items[idx] : sfwItems[idx];
  if(!item) return;
  document.getElementById('viewer-img').src = safeImageSrc(item.imageUrl);
  document.getElementById('viewer-title').textContent = item.title_zh || item.title_en || '未命名';
  document.getElementById('viewer-desc').textContent = item.description_zh || item.description_en || '';
  document.getElementById('viewer-tags').innerHTML = tagChips(item.tags);
  viewer.showModal();
}

// 统一入口：兼容你旧项目里可能调用的 renderInitialGalleries()
function renderInitialGalleries(){
  renderGallery(document.getElementById('gallery-sfw'), sfwItems, false);
  renderGallery(document.getElementById('gallery-r18'), r18Items, true);
  document.getElementById('sfw-count').textContent = sfwItems.length + ' 项';
  document.getElementById('r18-count').textContent = r18Items.length + ' 项';
}

// ============== 加载 CSV =============
async function fetchArtworks(){
  const sfwContainer = document.getElementById('gallery-sfw');
  const r18Container = document.getElementById('gallery-r18');
  try {
    const response = await fetch(CSV_URL, { method: 'GET', cache: 'no-store', redirect: 'follow' });
    if(!response.ok) throw new Error(`HTTP ${response.status} - ${response.url}`);
    const csvText = await response.text();
    console.log('[CSV] Loaded:', response.url, csvText.slice(0, 80));

    artworksData = parseCSV(csvText).reverse();
    sfwItems = artworksData.filter(x => String(x.category || '').toUpperCase() !== 'R-18');
    r18Items = artworksData.filter(x => String(x.category || '').toUpperCase() === 'R-18');

    // 顶部横幅如果你的样式里有 .hero-bg，可在此设置背景
    // const hero = document.querySelector('.hero-bg');
    // if(hero && sfwItems[0]?.imageUrl) hero.style.backgroundImage = `url('${safeImageSrc(sfwItems[0].imageUrl)}')`;

    renderInitialGalleries();
  } catch (err) {
    console.error('获取作品失败:', err);
    const msg = `<p class="text-center text-red-500 col-span-full">作品加载失败：${err.message}。请确认 /data/works.csv 能访问。</p>`;
    if (sfwContainer) sfwContainer.innerHTML = msg;
    if (r18Container) r18Container.innerHTML = '';
  }
}

document.addEventListener('DOMContentLoaded', fetchArtworks);
</script>
</body>
</html>
